name: Tests
on:
  push:
    branches: [main]
  pull_request:

jobs:
  functest:
    name: Functional Tests
    strategy:
      fail-fast: false
      matrix:
        runner:
          - self-hosted-linux-amd64-noble-medium
          - self-hosted-linux-arm64-noble-medium
          - self-hosted-linux-ppc64el-noble-edge
          - self-hosted-linux-s390x-noble-edge
    runs-on: ${{ matrix.runner }}
    steps:
      - name: debug
        run: |
          set -euxo pipefail
          sudo snap install --classic go
          go install github.com/canonical/concierge@latest
          # Use concierge to setup LXD, microk8s and bootstrap juju controller
          cat <<EOF >>/tmp/concierge.yaml
          juju:
            channel: 3.5/stable
          providers:
            microk8s:
              enable: true
              bootstrap: false
              channel: 1.32-strict/edge
              addons:
                - dns
                - hostpath-storage
                - metallb
            lxd:
              enable: true
              bootstrap: true
          EOF
          # Workaround for canonical/concierge#75
          sudo snap install microk8s --channel 1.32-strict/edge
          sudo mkdir -p /var/snap/microk8s/current/args/certs.d/docker.io
          cat <<EOF | sudo tee /var/snap/microk8s/current/args/certs.d/docker.io/hosts.toml
          server = "$DOCKERHUB_MIRROR"
          [host."$DOCKERHUB_MIRROR"]
          capabilities = ["pull", "resolve"]
          EOF
          sudo microk8s stop
          sudo microk8s start
          sudo $HOME/go/bin/concierge prepare -c /tmp/concierge.yaml
